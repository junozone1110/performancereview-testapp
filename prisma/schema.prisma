generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  employee
  manager
  hr
}

enum Half {
  first
  second
}

enum Phase {
  goal_setting
  goal_review
  self_evaluation
  self_confirmed
  manager_evaluation
  manager_confirmed
  hr_evaluation
  finalized
}

enum PerformanceRating {
  SS
  S
  A
  B
  C
}

enum CompetencyRating {
  LEVEL_2_0
  LEVEL_2_5
  LEVEL_3_0_MINUS
  LEVEL_3_0
  LEVEL_3_5
  LEVEL_4_0
}

enum Grade {
  G1
  G2
  G3
  G4
  G5
  G6
  G7
}

enum Treatment {
  raise
  maintain
  reduce
}

model User {
  id             String   @id @default(uuid())
  employeeNumber String   @unique @map("employee_number")
  email          String   @unique
  name           String
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  roles              UserRole[]
  periodAssignments  PeriodAssignment[]
  managedAssignments PeriodAssignment[] @relation("Manager")
  sheets             EvaluationSheet[]
  viewableSheets     AdditionalViewer[]
  createdViewers     AdditionalViewer[] @relation("CreatedBy")

  @@map("users")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  role      Role
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, role])
  @@map("user_roles")
}

model Department {
  id        String   @id @default(uuid())
  name      String
  parentId  String?  @map("parent_id")
  smarthrId String?  @map("smarthr_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent            Department?        @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children          Department[]       @relation("DepartmentHierarchy")
  periodAssignments PeriodAssignment[]

  @@map("departments")
}

model EvaluationPeriod {
  id           String   @id @default(uuid())
  name         String
  year         Int
  half         Half
  startDate    DateTime @map("start_date")
  endDate      DateTime @map("end_date")
  currentPhase Phase    @default(goal_setting) @map("current_phase")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  periodAssignments PeriodAssignment[]
  sheets            EvaluationSheet[]

  @@map("evaluation_periods")
}

model PeriodAssignment {
  id           String   @id @default(uuid())
  periodId     String   @map("period_id")
  userId       String   @map("user_id")
  departmentId String   @map("department_id")
  managerId    String   @map("manager_id")
  currentGrade Grade    @map("current_grade")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  period     EvaluationPeriod @relation(fields: [periodId], references: [id])
  user       User             @relation(fields: [userId], references: [id])
  department Department       @relation(fields: [departmentId], references: [id])
  manager    User             @relation("Manager", fields: [managerId], references: [id])

  @@unique([periodId, userId])
  @@map("period_assignments")
}

model EvaluationSheet {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  periodId  String   @map("period_id")
  status    Phase    @default(goal_setting)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user              User               @relation(fields: [userId], references: [id])
  period            EvaluationPeriod   @relation(fields: [periodId], references: [id])
  goals             Goal[]
  totalEvaluation   TotalEvaluation?
  additionalViewers AdditionalViewer[]

  @@unique([userId, periodId])
  @@map("evaluation_sheets")
}

model Goal {
  id                  String   @id @default(uuid())
  sheetId             String   @map("sheet_id")
  sortOrder           Int      @map("sort_order")
  title               String
  description         String?
  achievementCriteria String?  @map("achievement_criteria")
  weight              Int
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  sheet             EvaluationSheet        @relation(fields: [sheetId], references: [id])
  selfEvaluation    GoalSelfEvaluation?
  managerEvaluation GoalManagerEvaluation?

  @@map("goals")
}

model GoalSelfEvaluation {
  id                    String             @id @default(uuid())
  goalId                String             @unique @map("goal_id")
  performanceReflection String?            @map("performance_reflection")
  performanceRating     PerformanceRating? @map("performance_rating")
  competencyReflection1 String?            @map("competency_reflection_1")
  competencyReflection2 String?            @map("competency_reflection_2")
  competencyReflection3 String?            @map("competency_reflection_3")
  competencyRating      CompetencyRating?  @map("competency_rating")
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")

  goal Goal @relation(fields: [goalId], references: [id])

  @@map("goal_self_evaluations")
}

model GoalManagerEvaluation {
  id                 String             @id @default(uuid())
  goalId             String             @unique @map("goal_id")
  performanceComment String?            @map("performance_comment")
  performanceRating  PerformanceRating? @map("performance_rating")
  competencyComment  String?            @map("competency_comment")
  competencyRating   CompetencyRating?  @map("competency_rating")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  goal Goal @relation(fields: [goalId], references: [id])

  @@map("goal_manager_evaluations")
}

model TotalEvaluation {
  id                    String            @id @default(uuid())
  sheetId               String            @unique @map("sheet_id")
  averageScore          Decimal?          @map("average_score") @db.Decimal(3, 2)
  performanceComment    String?           @map("performance_comment")
  competencyLevel       CompetencyRating? @map("competency_level")
  competencyLevelReason String?           @map("competency_level_reason")
  mgrTreatment          Treatment?        @map("mgr_treatment")
  mgrSalaryChange       Int?              @map("mgr_salary_change")
  mgrTreatmentComment   String?           @map("mgr_treatment_comment")
  mgrGrade              Grade?            @map("mgr_grade")
  mgrGradeComment       String?           @map("mgr_grade_comment")
  hrTreatment           Treatment?        @map("hr_treatment")
  hrSalaryChange        Int?              @map("hr_salary_change")
  hrGrade               Grade?            @map("hr_grade")
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  sheet EvaluationSheet @relation(fields: [sheetId], references: [id])

  @@map("total_evaluations")
}

model AdditionalViewer {
  id           String   @id @default(uuid())
  sheetId      String   @map("sheet_id")
  viewerUserId String   @map("viewer_user_id")
  createdBy    String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")

  sheet   EvaluationSheet @relation(fields: [sheetId], references: [id])
  viewer  User            @relation(fields: [viewerUserId], references: [id])
  creator User            @relation("CreatedBy", fields: [createdBy], references: [id])

  @@map("additional_viewers")
}
